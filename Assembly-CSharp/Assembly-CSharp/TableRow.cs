// Decompiled with JetBrains decompiler
// Type: TableRow
// Assembly: Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: A8D8CAFB-CD16-4CDA-9F47-7D36796BFC75
// Assembly location: H:\Steam\steamapps\common\OxygenNotIncluded\OxygenNotIncluded_Data\Managed\Assembly-CSharp.dll

using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.UI;

[AddComponentMenu("KMonoBehaviour/scripts/TableRow")]
public class TableRow : KMonoBehaviour
{
  public TableRow.RowType rowType;
  private IAssignableIdentity minion;
  private Dictionary<TableColumn, GameObject> widgets = new Dictionary<TableColumn, GameObject>();
  private Dictionary<string, GameObject> scrollers = new Dictionary<string, GameObject>();
  private Dictionary<string, GameObject> scrollerBorders = new Dictionary<string, GameObject>();
  public bool isDefault;
  public KButton selectMinionButton;
  [SerializeField]
  private ColorStyleSetting style_setting_default;
  [SerializeField]
  private ColorStyleSetting style_setting_minion;
  [SerializeField]
  private GameObject scrollerPrefab;
  [SerializeField]
  private GameObject scrollbarPrefab;

  protected override void OnPrefabInit()
  {
    base.OnPrefabInit();
    if (!((UnityEngine.Object) this.selectMinionButton != (UnityEngine.Object) null))
      return;
    this.selectMinionButton.onClick += new System.Action(this.SelectMinion);
    this.selectMinionButton.onDoubleClick += new System.Action(this.SelectAndFocusMinion);
  }

  public GameObject GetScroller(string scrollerID) => this.scrollers[scrollerID];

  public GameObject GetScrollerBorder(string scrolledID) => this.scrollerBorders[scrolledID];

  public void SelectMinion()
  {
    MinionIdentity minion = this.minion as MinionIdentity;
    if ((UnityEngine.Object) minion == (UnityEngine.Object) null)
      return;
    SelectTool.Instance.Select(minion.GetComponent<KSelectable>());
  }

  public void SelectAndFocusMinion()
  {
    MinionIdentity minion = this.minion as MinionIdentity;
    if ((UnityEngine.Object) minion == (UnityEngine.Object) null)
      return;
    SelectTool.Instance.SelectAndFocus(minion.transform.GetPosition(), minion.GetComponent<KSelectable>(), new Vector3(8f, 0.0f, 0.0f));
  }

  public void ConfigureContent(IAssignableIdentity minion, Dictionary<string, TableColumn> columns)
  {
    this.minion = minion;
    KImage componentInChildren1 = this.GetComponentInChildren<KImage>(true);
    componentInChildren1.colorStyleSetting = minion == null ? this.style_setting_default : this.style_setting_minion;
    componentInChildren1.ColorState = KImage.ColorSelector.Inactive;
    CanvasGroup component = this.GetComponent<CanvasGroup>();
    if ((UnityEngine.Object) component != (UnityEngine.Object) null && (UnityEngine.Object) (minion as StoredMinionIdentity) != (UnityEngine.Object) null)
      component.alpha = 0.6f;
    foreach (KeyValuePair<string, TableColumn> column1 in columns)
    {
      KeyValuePair<string, TableColumn> column = column1;
      GameObject gameObject = minion != null ? column.Value.GetMinionWidget(this.gameObject) : (!this.isDefault ? column.Value.GetHeaderWidget(this.gameObject) : column.Value.GetDefaultWidget(this.gameObject));
      this.widgets.Add(column.Value, gameObject);
      column.Value.widgets_by_row.Add(this, gameObject);
      if (column.Key.Contains("scroller_spacer_") && (minion != null || this.isDefault))
        gameObject.GetComponentInChildren<LayoutElement>().minWidth += 3f;
      if (column.Value.scrollerID != "")
      {
        foreach (string columnScroller in column.Value.screen.column_scrollers)
        {
          if (columnScroller == column.Value.scrollerID)
          {
            if (!this.scrollers.ContainsKey(columnScroller))
            {
              KScrollRect scroll_rect = Util.KInstantiateUI(this.scrollerPrefab, this.gameObject, true).GetComponent<KScrollRect>();
              scroll_rect.onValueChanged.AddListener((UnityAction<Vector2>) (_param1 =>
              {
                foreach (Component row in column.Value.screen.rows)
                {
                  KScrollRect componentInChildren2 = row.GetComponentInChildren<KScrollRect>();
                  if ((UnityEngine.Object) componentInChildren2 != (UnityEngine.Object) null)
                    componentInChildren2.horizontalNormalizedPosition = scroll_rect.horizontalNormalizedPosition;
                }
              }));
              this.scrollers.Add(columnScroller, scroll_rect.content.gameObject);
              if ((UnityEngine.Object) scroll_rect.content.transform.parent.Find("Border") != (UnityEngine.Object) null)
                this.scrollerBorders.Add(columnScroller, scroll_rect.content.transform.parent.Find("Border").gameObject);
            }
            gameObject.transform.SetParent(this.scrollers[columnScroller].transform);
            this.scrollers[columnScroller].transform.parent.GetComponent<KScrollRect>().horizontalNormalizedPosition = 0.0f;
          }
        }
      }
    }
    foreach (KeyValuePair<string, TableColumn> column in columns)
    {
      if (column.Value.on_load_action != null)
        column.Value.on_load_action(minion, column.Value.widgets_by_row[this]);
    }
    if (minion != null)
      this.gameObject.name = minion.GetProperName();
    else if (this.isDefault)
      this.gameObject.name = "defaultRow";
    if ((bool) (UnityEngine.Object) this.selectMinionButton)
      this.selectMinionButton.transform.SetAsLastSibling();
    foreach (KeyValuePair<string, GameObject> scrollerBorder in this.scrollerBorders)
    {
      RectTransform transform = scrollerBorder.Value.rectTransform();
      float width = transform.rect.width;
      scrollerBorder.Value.transform.SetParent(this.gameObject.transform);
      transform.anchorMin = transform.anchorMax = new Vector2(0.0f, 1f);
      transform.sizeDelta = new Vector2(width, transform.sizeDelta.y);
      RectTransform rectTransform = this.scrollers[scrollerBorder.Key].transform.parent.rectTransform();
      Vector3 vector3 = this.scrollers[scrollerBorder.Key].transform.parent.rectTransform().GetLocalPosition() - new Vector3(rectTransform.sizeDelta.x / 2f, (float) (-1.0 * ((double) rectTransform.sizeDelta.y / 2.0)), 0.0f);
      vector3.y = 0.0f;
      transform.sizeDelta = new Vector2(transform.sizeDelta.x, 374f);
      transform.SetLocalPosition(vector3 + Vector3.up * transform.GetLocalPosition().y + Vector3.up * -transform.anchoredPosition.y);
    }
  }

  public void RefreshScrollers()
  {
    foreach (KeyValuePair<string, GameObject> scroller in this.scrollers)
    {
      KScrollRect component = scroller.Value.transform.parent.GetComponent<KScrollRect>();
      component.GetComponent<LayoutElement>().minWidth = Mathf.Min(768f, component.content.sizeDelta.x);
    }
    foreach (KeyValuePair<string, GameObject> scrollerBorder in this.scrollerBorders)
    {
      RectTransform rectTransform = scrollerBorder.Value.rectTransform();
      rectTransform.sizeDelta = new Vector2(this.scrollers[scrollerBorder.Key].transform.parent.GetComponent<LayoutElement>().minWidth, rectTransform.sizeDelta.y);
    }
  }

  public GameObject GetWidget(TableColumn column)
  {
    if (this.widgets.ContainsKey(column) && (UnityEngine.Object) this.widgets[column] != (UnityEngine.Object) null)
      return this.widgets[column];
    Debug.LogWarning((object) ("Widget is null or row does not contain widget for column " + (object) column));
    return (GameObject) null;
  }

  public IAssignableIdentity GetIdentity() => this.minion;

  public bool ContainsWidget(GameObject widget) => this.widgets.ContainsValue(widget);

  public void Clear()
  {
    foreach (KeyValuePair<TableColumn, GameObject> widget in this.widgets)
      widget.Key.widgets_by_row.Remove(this);
    UnityEngine.Object.Destroy((UnityEngine.Object) this.gameObject);
  }

  public enum RowType
  {
    Header,
    Default,
    Minion,
    StoredMinon,
  }
}
